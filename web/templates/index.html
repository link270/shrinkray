<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shrinkray</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F5F5F5;
            --text-primary: #1A1A1A;
            --text-secondary: #6B6B6B;
            --text-tertiary: #9A9A9A;
            --accent: #2563EB;
            --accent-hover: #1D4ED8;
            --accent-light: #EFF6FF;
            --success: #059669;
            --success-light: #ECFDF5;
            --warning: #D97706;
            --warning-light: #FFFBEB;
            --error: #DC2626;
            --error-light: #FEF2F2;
            --border: #E5E5E5;
            --border-hover: #D4D4D4;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        [data-theme="dark"] {
            --bg-primary: #0F0F0F;
            --bg-secondary: #1A1A1A;
            --bg-tertiary: #252525;
            --text-primary: #F5F5F5;
            --text-secondary: #A0A0A0;
            --text-tertiary: #6B6B6B;
            --accent: #3B82F6;
            --accent-hover: #60A5FA;
            --accent-light: #1E3A5F;
            --success: #10B981;
            --success-light: #064E3B;
            --warning: #F59E0B;
            --warning-light: #78350F;
            --error: #EF4444;
            --error-light: #7F1D1D;
            --border: #2D2D2D;
            --border-hover: #404040;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.4);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Layout */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.125rem;
            letter-spacing: -0.02em;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .stats-bar {
            display: flex;
            gap: 24px;
            margin-left: 40px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-weight: 600;
            font-size: 0.9375rem;
            font-variant-numeric: tabular-nums;
        }

        .stat-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .stat-item.success .stat-value { color: var(--success); }
        .stat-item.running .stat-value { color: var(--accent); }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .menu-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .menu-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Theme toggle icons */
        .theme-icon-light { display: none; }
        .theme-icon-dark { display: block; }
        [data-theme="dark"] .theme-icon-light { display: block; }
        [data-theme="dark"] .theme-icon-dark { display: none; }

        .main {
            flex: 1;
            display: flex;
            align-items: flex-start;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            padding: 24px;
            gap: 24px;
            min-height: 0;
            overflow: hidden;
        }

        /* Browser Panel */
        .browser-panel {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        /* File browser panel - sizes to content */
        .browser-panel > .panel {
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 112px);
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-weight: 600;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .breadcrumb a:hover {
            color: var(--accent-hover);
        }

        .breadcrumb-sep {
            color: var(--text-tertiary);
            margin: 0 4px;
        }

        .breadcrumb-current {
            color: var(--text-primary);
            font-weight: 500;
        }

        .file-list {
            list-style: none;
            overflow-y: auto;
        }

        .file-list-header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            font-size: 0.8125rem;
            color: var(--text-secondary);
            gap: 12px;
            flex-shrink: 0;
        }

        .file-list-header label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background var(--transition-fast);
            gap: 12px;
        }

        .file-item:hover {
            background: var(--bg-tertiary);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item.selected {
            background: var(--accent-light);
        }

        .file-item.selected:hover {
            background: #DBEAFE;
        }

        .file-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .file-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .file-icon.folder {
            background: #FEF3C7;
            color: #D97706;
        }

        .file-icon.video {
            background: var(--accent-light);
            color: var(--accent);
        }

        .file-icon.other {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.9375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 2px;
            display: flex;
            gap: 12px;
        }

        .file-size {
            font-variant-numeric: tabular-nums;
            color: var(--text-tertiary);
            font-size: 0.8125rem;
            flex-shrink: 0;
        }

        .codec-badge {
            display: inline-flex;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .codec-badge.hevc,
        .codec-badge.av1 {
            background: var(--success-light);
            color: var(--success);
        }

        .codec-badge.h264 {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .file-list-empty {
            padding: 60px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Actions Bar */
        .actions-bar {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            align-items: center;
            flex-shrink: 0;
        }

        .preset-select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: var(--font-sans);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            min-width: 200px;
            transition: border-color var(--transition-fast);
        }

        .preset-select:hover {
            border-color: var(--border-hover);
        }

        .preset-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            font-family: var(--font-sans);
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #B91C1C;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8125rem;
        }

        .selection-count {
            margin-left: auto;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* Queue Panel */
        .queue-panel {
            width: 400px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: calc(100vh - 112px); /* viewport - header - padding */
        }

        .queue-panel-inner {
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .queue-list {
            overflow-y: auto;
        }

        .job-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .job-item:last-child {
            border-bottom: none;
        }

        .job-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 8px;
        }

        .job-name {
            font-weight: 500;
            font-size: 0.9375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .job-badges {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .job-badge {
            display: inline-flex;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .job-badge.pending {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .job-badge.running {
            background: var(--accent-light);
            color: var(--accent);
        }

        .job-badge.complete {
            background: var(--success-light);
            color: var(--success);
        }

        .job-badge.failed {
            background: var(--error-light);
            color: var(--error);
        }

        .job-badge.initializing {
            background: #F3E8FF;
            color: #7C3AED;
        }

        .job-badge.hardware {
            background: var(--success-light);
            color: var(--success);
        }

        .job-badge.software {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .job-progress {
            margin: 12px 0;
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width var(--transition-normal);
        }

        .progress-fill.initializing {
            background: linear-gradient(90deg, #DDD6FE 0%, #A78BFA 50%, #DDD6FE 100%);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .job-details {
            display: flex;
            gap: 16px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .job-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .job-detail-value {
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        .job-saved {
            color: var(--success);
        }

        .job-error {
            color: var(--error);
            font-size: 0.8125rem;
            margin-top: 8px;
        }

        .job-actions {
            margin-top: 12px;
        }

        .queue-empty {
            padding: 24px 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        .queue-empty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        /* Processing Banner */
        .processing-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--accent-light);
            border-bottom: 1px solid var(--border);
            color: var(--accent);
            font-weight: 500;
            font-size: 0.875rem;
        }
        .processing-banner.hidden { display: none; }
        .processing-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }

        .queue-footer {
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .notify-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        .notify-label input {
            accent-color: var(--accent);
            cursor: pointer;
        }

        /* Settings Menu */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 400px;
            max-width: 100%;
            background: var(--bg-secondary);
            z-index: 201;
            transform: translateX(100%);
            transition: transform var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        .settings-overlay.open .settings-panel {
            transform: translateX(0);
        }

        .settings-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .settings-close {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .settings-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .setting-group {
            margin-bottom: 32px;
        }

        .setting-group:last-child {
            margin-bottom: 0;
        }

        .setting-group-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-name {
            font-weight: 500;
            font-size: 0.9375rem;
            margin-bottom: 2px;
        }

        .setting-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .setting-control {
            margin-left: 16px;
        }

        .setting-select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: var(--font-sans);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            min-width: 160px;
        }

        .setting-input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: var(--font-sans);
            background: var(--bg-secondary);
            color: var(--text-primary);
            width: 200px;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .setting-input::placeholder {
            color: var(--text-tertiary);
        }

        .settings-status {
            padding: 12px 24px;
            font-size: 0.8125rem;
            color: var(--success);
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .settings-status.error {
            color: var(--error);
        }

        .settings-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-tertiary);
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main {
                flex-direction: column;
                overflow-y: auto;
                align-items: stretch;
            }

            .browser-panel {
                flex: none;
            }

            .file-list {
                max-height: 50vh;
            }

            .queue-panel {
                width: 100%;
                position: static;
                align-self: stretch;
                max-height: none;
            }

            .queue-panel-inner {
                max-height: none;
            }

            .queue-list {
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }

            .stats-bar {
                gap: 12px;
                margin-left: 16px;
            }

            .stat-label {
                display: none;
            }

            .stat-value {
                font-size: 0.8125rem;
            }

            .main {
                padding: 16px;
                gap: 16px;
            }

            .settings-panel {
                width: 100%;
            }

            .actions-bar {
                flex-wrap: wrap;
            }

            .preset-select {
                width: 100%;
                min-width: 0;
            }
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 420px;
            width: calc(100% - 32px);
            padding: 24px;
            transform: scale(0.95) translateY(10px);
            transition: transform var(--transition-normal);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .modal-message {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            min-width: 100px;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="/logo.png" alt="Shrinkray" width="32" height="32">
                    </div>
                    Shrinkray
                </div>
                <div class="stats-bar" id="stats-bar">
                    <div class="stat-item running">
                        <span class="stat-value" id="stat-running">0</span>
                        <span class="stat-label">running</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="stat-pending">0</span>
                        <span class="stat-label">pending</span>
                    </div>
                    <div class="stat-item success">
                        <span class="stat-value" id="stat-saved">0 MB</span>
                        <span class="stat-label">saved</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="menu-btn" onclick="toggleTheme()" title="Toggle dark mode" id="theme-toggle">
                    <svg class="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg class="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                <button class="menu-btn" onclick="openSettings()" title="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
            </div>
        </header>

        <main class="main">
            <div class="browser-panel">
                <div class="panel">
                    <div class="breadcrumb" id="breadcrumb">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading...
                        </div>
                    </div>
                    <div class="file-list-header hidden" id="file-list-header">
                        <label>
                            <input type="checkbox" class="file-checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this)">
                            Select all
                        </label>
                        <span id="selection-count"></span>
                    </div>
                    <ul class="file-list" id="file-list">
                        <li class="loading">
                            <div class="spinner"></div>
                            Loading files...
                        </li>
                    </ul>
                    <div class="actions-bar">
                        <select class="preset-select" id="preset-select" onchange="onPresetChange()">
                            <option value="compress-hevc">Compress (HEVC)</option>
                        </select>
                        <button class="btn btn-primary" onclick="startJobs()" id="start-btn" disabled>Start Transcode</button>
                        <span class="selection-count" id="selection-summary"></span>
                    </div>
                </div>
            </div>

            <div class="queue-panel">
                <div class="panel queue-panel-inner">
                    <div class="panel-header">
                        <span class="panel-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="8" y1="6" x2="21" y2="6"/>
                                <line x1="8" y1="12" x2="21" y2="12"/>
                                <line x1="8" y1="18" x2="21" y2="18"/>
                                <line x1="3" y1="6" x2="3.01" y2="6"/>
                                <line x1="3" y1="12" x2="3.01" y2="12"/>
                                <line x1="3" y1="18" x2="3.01" y2="18"/>
                            </svg>
                            Queue
                        </span>
                        <label class="notify-label" id="notify-container" style="display: none">
                            <input type="checkbox" id="notify-checkbox" onchange="updateNotifySetting(this.checked)">
                            <span>Notify when done</span>
                        </label>
                    </div>
                    <div id="processing-banner" class="processing-banner hidden">
                        <div class="processing-spinner"></div>
                        <span id="processing-text">Processing files...</span>
                    </div>
                    <div class="queue-list" id="queue-list">
                        <div class="queue-empty">
                            <div class="queue-empty-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M3 9h18"/>
                                    <path d="M9 21V9"/>
                                </svg>
                            </div>
                            <div>No jobs in queue</div>
                            <div style="font-size: 0.8125rem; margin-top: 4px; color: var(--text-tertiary)">Select files and start transcoding</div>
                        </div>
                    </div>
                    <div class="queue-footer">
                        <button class="btn btn-secondary btn-sm" onclick="clearQueue()" style="flex: 1">Clear Queue</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settings-overlay" onclick="closeSettings(event)">
        <div class="settings-panel" onclick="event.stopPropagation()">
            <div class="settings-header">
                <span class="settings-title">Settings</span>
                <button class="settings-close" onclick="closeSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="settings-content">
                <div class="setting-group">
                    <div class="setting-group-title">Transcoding</div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">Original files</div>
                            <div class="setting-desc">What happens after transcoding</div>
                        </div>
                        <div class="setting-control">
                            <select class="setting-select" id="setting-original-handling" onchange="updateSetting('original_handling', this.value)">
                                <option value="replace">Delete original</option>
                                <option value="keep">Keep as .old</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">Concurrent jobs</div>
                            <div class="setting-desc">Simultaneous transcode tasks</div>
                        </div>
                        <div class="setting-control">
                            <select class="setting-select" id="setting-workers" onchange="updateSetting('workers', parseInt(this.value))">
                                <option value="1">1 (recommended)</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="setting-group">
                    <div class="setting-group-title">Notifications</div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">Pushover User Key</div>
                            <div class="setting-desc">Your Pushover user/group key</div>
                        </div>
                        <div class="setting-control">
                            <input type="text" class="setting-input" id="setting-pushover-user"
                                   placeholder="Enter user key" onchange="updateSetting('pushover_user_key', this.value)">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">Pushover App Token</div>
                            <div class="setting-desc">Your Pushover application token</div>
                        </div>
                        <div class="setting-control">
                            <input type="text" class="setting-input" id="setting-pushover-token"
                                   placeholder="Enter app token" onchange="updateSetting('pushover_app_token', this.value)">
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">Test Notification</div>
                            <div class="setting-desc">Send a test to verify setup</div>
                        </div>
                        <div class="setting-control">
                            <button class="btn btn-secondary btn-sm" id="test-pushover-btn" onclick="testPushover()">Test</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-status" id="settings-status"></div>
            <div class="settings-footer">Shrinkray v<span id="app-version"></span></div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay" onclick="closeConfirmModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title" id="confirm-modal-title">Confirm</div>
            <div class="modal-message" id="confirm-modal-message"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-primary" id="confirm-modal-action">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize theme immediately to prevent flash
        (function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        let currentPath = '';
        let selectedPaths = new Set();
        let selectedFileCounts = new Map();  // Track file count for each selected path (1 for files, N for folders)
        let totalSelectableCount = 0;  // Track total selectable items to avoid DOM queries
        let eventSource = null;

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            if (bytes < 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        async function browse(path = '') {
            try {
                const url = path ? `/api/browse?path=${encodeURIComponent(path)}` : '/api/browse';
                const resp = await fetch(url);
                const data = await resp.json();

                currentPath = data.path;
                selectedPaths.clear();
                selectedFileCounts.clear();
                updateButtons();

                // Update breadcrumb
                const breadcrumb = document.getElementById('breadcrumb');
                let crumbs = `<a href="#" onclick="browse(''); return false;">Home</a>`;
                if (data.parent) {
                    crumbs += `<span class="breadcrumb-sep">/</span>`;
                    crumbs += `<a href="#" onclick="browse('${data.parent}'); return false;">...</a>`;
                }
                const currentFolder = data.path.split('/').pop() || 'Root';
                crumbs += `<span class="breadcrumb-sep">/</span>`;
                crumbs += `<span class="breadcrumb-current">${currentFolder}</span>`;
                breadcrumb.innerHTML = crumbs;

                // Update file list
                const list = document.getElementById('file-list');
                if (data.entries.length === 0) {
                    list.innerHTML = '<li class="file-list-empty">This folder is empty</li>';
                    document.getElementById('file-list-header').classList.add('hidden');
                    return;
                }

                // Count selectable items (videos or folders) to avoid DOM queries later
                totalSelectableCount = data.entries.filter(e =>
                    (!e.is_dir && e.video_info) || e.is_dir
                ).length;
                const header = document.getElementById('file-list-header');
                const selectAllCheckbox = document.getElementById('select-all-checkbox');

                if (totalSelectableCount > 0) {
                    header.classList.remove('hidden');
                } else {
                    header.classList.add('hidden');
                }
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;

                list.innerHTML = data.entries.map(entry => {
                    const isVideo = !entry.is_dir && entry.video_info;
                    const isFolder = entry.is_dir;
                    const isSelectable = isVideo || isFolder;
                    const iconClass = entry.is_dir ? 'folder' : (isVideo ? 'video' : 'other');
                    const icon = entry.is_dir
                        ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>`
                        : isVideo
                            ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>`
                            : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`;

                    let metaHtml = '';
                    // For folders, file_count is the number of videos inside; for videos it's 1
                    const fileCount = entry.is_dir ? (entry.file_count || 0) : (isVideo ? 1 : 0);
                    if (entry.is_dir) {
                        const count = entry.file_count || 0;
                        if (count > 0) {
                            const size = formatBytes(entry.total_size || 0);
                            metaHtml = `<span>${count} video${count !== 1 ? 's' : ''}</span><span>${size}</span>`;
                        }
                    } else if (isVideo) {
                        const vi = entry.video_info;
                        const codec = vi.video_codec?.toLowerCase() || '';
                        let codecClass = 'h264';
                        if (codec.includes('hevc') || codec.includes('h265')) {
                            codecClass = 'hevc';
                        } else if (codec.includes('av1')) {
                            codecClass = 'av1';
                        }
                        metaHtml = `<span class="codec-badge ${codecClass}">${vi.video_codec}</span><span>${vi.width}x${vi.height}</span>`;
                    }

                    return `<li class="file-item" data-path="${entry.path}" data-is-dir="${entry.is_dir}" onclick="handleFileClick(this, event)">
                        ${isSelectable ? `<input type="checkbox" class="file-checkbox" onclick="handleCheckbox(this, event)" data-path="${entry.path}" data-file-count="${fileCount}">` : '<div style="width: 18px"></div>'}
                        <div class="file-icon ${iconClass}">${icon}</div>
                        <div class="file-info">
                            <div class="file-name">${entry.name}</div>
                            <div class="file-meta">${metaHtml}</div>
                        </div>
                        ${entry.is_dir ? '' : `<div class="file-size">${formatBytes(entry.size)}</div>`}
                    </li>`;
                }).join('');

            } catch (err) {
                console.error('Browse error:', err);
            }
        }

        function handleCheckbox(checkbox, event) {
            event.stopPropagation();
            const path = checkbox.dataset.path;
            const fileCount = parseInt(checkbox.dataset.fileCount) || 1;
            const row = checkbox.closest('.file-item');

            if (checkbox.checked) {
                selectedPaths.add(path);
                selectedFileCounts.set(path, fileCount);
                row.classList.add('selected');
            } else {
                selectedPaths.delete(path);
                selectedFileCounts.delete(path);
                row.classList.remove('selected');
            }
            updateButtons();
        }

        function handleFileClick(el, event) {
            if (event.target.classList.contains('file-checkbox')) return;

            const path = el.dataset.path;
            const isDir = el.dataset.isDir === 'true';

            if (isDir) {
                browse(path);
            } else {
                const checkbox = el.querySelector('.file-checkbox');
                if (checkbox) {
                    const fileCount = parseInt(checkbox.dataset.fileCount) || 1;
                    checkbox.checked = !checkbox.checked;
                    if (checkbox.checked) {
                        selectedPaths.add(path);
                        selectedFileCounts.set(path, fileCount);
                        el.classList.add('selected');
                    } else {
                        selectedPaths.delete(path);
                        selectedFileCounts.delete(path);
                        el.classList.remove('selected');
                    }
                    updateButtons();
                }
            }
        }

        function toggleSelectAll(checkbox) {
            const isChecked = checkbox.checked;
            const allCheckboxes = document.querySelectorAll('.file-item .file-checkbox');

            // Batch DOM operations: collect all data first (reads), then do all updates (writes)
            const items = [];
            allCheckboxes.forEach(cb => {
                items.push({
                    cb,
                    row: cb.closest('.file-item'),
                    path: cb.dataset.path,
                    fileCount: parseInt(cb.dataset.fileCount) || 1
                });
            });

            // Clear or populate selectedPaths in one go
            if (isChecked) {
                items.forEach(({cb, row, path, fileCount}) => {
                    cb.checked = true;
                    row.classList.add('selected');
                    selectedPaths.add(path);
                    selectedFileCounts.set(path, fileCount);
                });
            } else {
                selectedPaths.clear();
                selectedFileCounts.clear();
                items.forEach(({cb, row}) => {
                    cb.checked = false;
                    row.classList.remove('selected');
                });
            }
            updateButtons();
        }

        function updateButtons() {
            const hasSelection = selectedPaths.size > 0;
            document.getElementById('start-btn').disabled = !hasSelection;

            const summary = document.getElementById('selection-summary');
            if (hasSelection) {
                summary.textContent = `${selectedPaths.size} file${selectedPaths.size > 1 ? 's' : ''} selected`;
            } else {
                summary.textContent = '';
            }

            // Update select-all checkbox using cached count (avoids O(n) DOM query)
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (totalSelectableCount > 0) {
                const allChecked = selectedPaths.size === totalSelectableCount;
                const someChecked = selectedPaths.size > 0;
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
            }
        }

        function onPresetChange() {
            // Preset changed - no action needed since estimation is removed
        }

        async function startJobs() {
            if (selectedPaths.size === 0) return;

            try {
                const preset = document.getElementById('preset-select').value;
                // Sum up total files: for folders use their file_count, for files use 1
                let totalFiles = 0;
                for (const count of selectedFileCounts.values()) {
                    totalFiles += count;
                }

                const resp = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paths: Array.from(selectedPaths),
                        preset_id: preset
                    })
                });
                const data = await resp.json();

                // Check for validation errors (bad request)
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Show processing indicator for async job creation
                const banner = document.getElementById('processing-banner');
                document.getElementById('processing-text').textContent =
                    `Processing ${totalFiles} file${totalFiles !== 1 ? 's' : ''}...`;
                banner.classList.remove('hidden');

                // Clear selections immediately - jobs will appear via SSE as they're processed
                selectedPaths.clear();
                selectedFileCounts.clear();
                document.querySelectorAll('.file-item.selected').forEach(el => {
                    el.classList.remove('selected');
                    const cb = el.querySelector('.file-checkbox');
                    if (cb) cb.checked = false;
                });
                updateButtons();

                // Reset select-all checkbox
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }

            } catch (err) {
                console.error('Start jobs error:', err);
            }
        }

        async function cancelJob(id) {
            try {
                await fetch(`/api/jobs/${id}`, { method: 'DELETE' });
            } catch (err) {
                console.error('Cancel error:', err);
            }
        }

        async function retryJob(id) {
            try {
                const resp = await fetch(`/api/jobs/${id}/retry`, { method: 'POST' });
                if (!resp.ok) {
                    const data = await resp.json();
                    alert(data.error || 'Failed to retry job');
                }
            } catch (err) {
                console.error('Retry error:', err);
            }
        }

        function clearQueue() {
            showConfirmModal(
                'Clear Queue',
                'This will remove all non-active jobs from the queue (including pending jobs). Your active jobs will not be affected.',
                async () => {
                    try {
                        await fetch('/api/jobs/clear', { method: 'POST' });
                        refreshJobs();
                    } catch (err) {
                        console.error('Clear error:', err);
                    }
                }
            );
        }

        // Confirm Modal
        let confirmCallback = null;

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').classList.add('active');
        }

        function closeConfirmModal(event) {
            // If called from overlay click, only close if clicking the overlay itself
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('confirm-modal').classList.remove('active');
            confirmCallback = null;
        }

        document.getElementById('confirm-modal-action').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        });

        async function refreshJobs() {
            try {
                const resp = await fetch('/api/jobs');
                const data = await resp.json();
                updateJobs(data.jobs);
                updateStats(data.stats);
            } catch (err) {
                console.error('Refresh error:', err);
            }
        }

        // Helper to render a single job's HTML
        function renderJobHTML(job) {
            const filename = job.input_path.split('/').pop();
            const isInitializing = job.status === 'running' && job.progress === 0 && job.speed === 0;
            const statusClass = isInitializing ? 'initializing' : job.status;
            const statusLabel = isInitializing ? 'Initializing' : job.status.charAt(0).toUpperCase() + job.status.slice(1);

            let detailsHtml = '';
            if (job.status === 'running') {
                if (isInitializing) {
                    detailsHtml = '<span class="job-detail">Starting encoder...</span>';
                } else {
                    detailsHtml = `
                        <span class="job-detail"><span class="job-detail-value">${job.progress.toFixed(1)}%</span></span>
                        <span class="job-detail"><span class="job-detail-value">${job.speed.toFixed(2)}x</span></span>
                        <span class="job-detail">ETA: <span class="job-detail-value">${job.eta || '...'}</span></span>
                    `;
                }
            } else if (job.status === 'complete') {
                detailsHtml = `
                    <span class="job-detail job-saved">Saved <span class="job-detail-value">${formatBytes(job.space_saved)}</span></span>
                    <span class="job-detail">${formatBytes(job.input_size)}  ${formatBytes(job.output_size)}</span>
                    ${job.transcode_secs ? `<span class="job-detail">in <span class="job-detail-value">${formatDuration(job.transcode_secs)}</span></span>` : ''}
                `;
            }

            return `
                <div class="job-item">
                    <div class="job-header">
                        <span class="job-name" title="${job.input_path}">${filename}</span>
                        <div class="job-badges">
                            <span class="job-badge ${job.is_hardware ? 'hardware' : 'software'}">${job.is_hardware ? 'HW' : 'SW'}</span>
                            <span class="job-badge ${statusClass}">${statusLabel}</span>
                        </div>
                    </div>
                    ${job.status === 'running' ? `
                        <div class="job-progress">
                            <div class="progress-bar">
                                <div class="progress-fill ${isInitializing ? 'initializing' : ''}" style="width: ${isInitializing ? 100 : job.progress}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="job-details">${detailsHtml}</div>
                    ${job.status === 'failed' ? `<div class="job-error">${job.error}</div>` : ''}
                    ${job.status === 'pending' || job.status === 'running' ? `
                        <div class="job-actions">
                            <button class="btn btn-secondary btn-sm" onclick="cancelJob('${job.id}')">Cancel</button>
                        </div>
                    ` : ''}
                    ${job.status === 'failed' ? `
                        <div class="job-actions">
                            <button class="btn btn-secondary btn-sm" onclick="retryJob('${job.id}')">Retry</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Infinite scroll state
        const JOBS_PER_PAGE = 50;
        let allSortedJobs = [];
        let displayedJobCount = 0;

        function updateJobs(jobs) {
            const container = document.getElementById('queue-list');

            if (!jobs || jobs.length === 0) {
                allSortedJobs = [];
                displayedJobCount = 0;
                container.innerHTML = `
                    <div class="queue-empty">
                        <div class="queue-empty-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.3">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18"/>
                                <path d="M9 21V9"/>
                            </svg>
                        </div>
                        <div>No jobs in queue</div>
                        <div style="font-size: 0.8125rem; margin-top: 4px; color: var(--text-tertiary)">Select files and start transcoding</div>
                    </div>
                `;
                return;
            }

            // Sort jobs by status: running first, then pending, failed, completed
            const statusOrder = { running: 0, pending: 1, failed: 2, complete: 3, cancelled: 4 };
            allSortedJobs = [...jobs].sort((a, b) => {
                const orderA = statusOrder[a.status] ?? 5;
                const orderB = statusOrder[b.status] ?? 5;
                return orderA - orderB;
            });

            // Render initial batch
            displayedJobCount = 0;
            container.innerHTML = '';
            loadMoreJobs();
        }

        function loadMoreJobs() {
            if (displayedJobCount >= allSortedJobs.length) return;

            const container = document.getElementById('queue-list');
            const fragment = document.createDocumentFragment();
            const temp = document.createElement('div');

            const endIndex = Math.min(displayedJobCount + JOBS_PER_PAGE, allSortedJobs.length);
            for (let i = displayedJobCount; i < endIndex; i++) {
                temp.innerHTML = renderJobHTML(allSortedJobs[i]);
                fragment.appendChild(temp.firstElementChild);
            }

            // Remove existing "load more" indicator if present
            const existingIndicator = container.querySelector('.load-more-indicator');
            if (existingIndicator) existingIndicator.remove();

            container.appendChild(fragment);
            displayedJobCount = endIndex;

            // Add "scroll for more" indicator if there are more jobs
            if (displayedJobCount < allSortedJobs.length) {
                const remaining = allSortedJobs.length - displayedJobCount;
                const indicator = document.createElement('div');
                indicator.className = 'load-more-indicator';
                indicator.style.cssText = 'text-align: center; padding: 16px; color: var(--text-secondary); font-size: 0.875rem;';
                indicator.textContent = `Scroll for ${remaining.toLocaleString()} more jobs...`;
                container.appendChild(indicator);
            }
        }

        // Set up infinite scroll listener
        (function setupInfiniteScroll() {
            const container = document.getElementById('queue-list');
            container.addEventListener('scroll', () => {
                // Load more when scrolled near bottom (within 100px)
                const nearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
                if (nearBottom && displayedJobCount < allSortedJobs.length) {
                    loadMoreJobs();
                }
            });
        })();

        function updateStats(stats) {
            document.getElementById('stat-pending').textContent = stats.pending;
            document.getElementById('stat-running').textContent = stats.running;
            const saved = Math.max(0, stats.total_saved || 0);
            document.getElementById('stat-saved').textContent = formatBytes(saved);
        }

        // Debounced refresh to avoid UI thrashing when many jobs are added
        let refreshTimeout = null;
        let browseTimeout = null;
        function scheduleRefresh() {
            if (!refreshTimeout) {
                refreshTimeout = setTimeout(() => {
                    refreshTimeout = null;
                    refreshJobs();
                }, 200);
            }
        }
        function scheduleBrowseRefresh() {
            if (!browseTimeout) {
                browseTimeout = setTimeout(() => {
                    browseTimeout = null;
                    browse(currentPath);
                }, 500);
            }
        }

        function connectSSE() {
            if (eventSource) eventSource.close();

            eventSource = new EventSource('/api/jobs/stream');

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'init') {
                    updateJobs(data.jobs);
                    updateStats(data.stats);
                } else if (data.type === 'notify_sent') {
                    // Notification was sent, uncheck the checkbox
                    document.getElementById('notify-checkbox').checked = false;
                } else if (data.type === 'discovery_progress') {
                    // Update processing banner with progress
                    const banner = document.getElementById('processing-banner');
                    banner.classList.remove('hidden');
                    document.getElementById('processing-text').textContent =
                        `Processing file ${data.probed}/${data.total}...`;
                } else if (data.type === 'jobs_added') {
                    // Batch of jobs finished processing, hide banner and refresh
                    document.getElementById('processing-banner').classList.add('hidden');
                    scheduleRefresh();
                } else {
                    scheduleRefresh();
                    if (data.type === 'complete' || data.type === 'failed') {
                        scheduleBrowseRefresh();
                    }
                }
            };

            eventSource.onerror = () => {
                setTimeout(connectSSE, 2000);
            };
        }

        // Settings
        function openSettings() {
            document.getElementById('settings-overlay').classList.add('open');
        }

        function closeSettings(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('settings-overlay').classList.remove('open');
        }

        async function loadSettings() {
            try {
                const resp = await fetch('/api/config');
                const config = await resp.json();

                // Display version
                if (config.version) {
                    document.getElementById('app-version').textContent = config.version;
                }

                document.getElementById('setting-original-handling').value = config.original_handling || 'replace';
                document.getElementById('setting-workers').value = config.workers || 1;

                // Pushover settings
                document.getElementById('setting-pushover-user').value = config.pushover_user_key || '';
                document.getElementById('setting-pushover-token').value = config.pushover_app_token || '';

                // Show/hide notify checkbox based on whether Pushover is configured
                const notifyContainer = document.getElementById('notify-container');
                const notifyCheckbox = document.getElementById('notify-checkbox');
                if (config.pushover_configured) {
                    notifyContainer.style.display = 'flex';
                    notifyCheckbox.checked = config.notify_on_complete || false;
                } else {
                    notifyContainer.style.display = 'none';
                }
            } catch (err) {
                console.error('Load settings error:', err);
            }
        }

        async function updateSetting(key, value) {
            const statusEl = document.getElementById('settings-status');
            try {
                const body = {};
                body[key] = value;

                const resp = await fetch('/api/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!resp.ok) {
                    const data = await resp.json();
                    throw new Error(data.error || 'Failed to update');
                }

                statusEl.textContent = 'Settings saved';
                statusEl.className = 'settings-status';
                setTimeout(() => { statusEl.textContent = ''; }, 2000);

                // Reload settings to update notify checkbox visibility
                if (key === 'pushover_user_key' || key === 'pushover_app_token') {
                    loadSettings();
                }
            } catch (err) {
                statusEl.textContent = `Error: ${err.message}`;
                statusEl.className = 'settings-status error';
            }
        }

        async function updateNotifySetting(checked) {
            try {
                await fetch('/api/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notify_on_complete: checked })
                });
            } catch (err) {
                console.error('Update notify setting error:', err);
            }
        }

        async function testPushover() {
            const btn = document.getElementById('test-pushover-btn');
            const statusEl = document.getElementById('settings-status');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const resp = await fetch('/api/pushover/test', { method: 'POST' });
                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || 'Failed to send test');
                }

                statusEl.textContent = 'Test notification sent!';
                statusEl.className = 'settings-status';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            } catch (err) {
                statusEl.textContent = `Error: ${err.message}`;
                statusEl.className = 'settings-status error';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test';
            }
        }

        async function loadPresets() {
            try {
                const presets = await fetch('/api/presets').then(r => r.json());
                const select = document.getElementById('preset-select');
                select.innerHTML = presets.map(p =>
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
            } catch (err) {
                console.error('Load presets error:', err);
            }
        }

        // Keyboard shortcut for settings
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSettings();
            }
        });

        // Initialize
        browse();
        connectSSE();
        loadSettings();
        loadPresets();
    </script>
</body>
</html>
