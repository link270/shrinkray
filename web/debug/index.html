<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shrinkray - Debug UI</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        h1, h2, h3 {
            font-weight: 600;
        }
        h1 {
            margin-bottom: 20px;
            color: #1d1d1f;
        }
        h2 {
            margin: 30px 0 15px;
            color: #1d1d1f;
            font-size: 1.25rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .stat {
            text-align: center;
            padding: 15px;
            background: #f5f5f7;
            border-radius: 8px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #0071e3;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #86868b;
        }
        .file-list {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }
        .file-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            cursor: pointer;
            text-align: left;
            gap: 12px;
        }
        .file-name {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-item:hover {
            background: #f5f5f7;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-item.dir .file-name {
            font-weight: 500;
        }
        .file-item.selected {
            background: #e8f4ff;
        }
        .file-meta {
            color: #86868b;
            font-size: 0.875rem;
            flex-shrink: 0;
            text-align: right;
        }
        .file-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .file-icon {
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }
        .file-list-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #f5f5f7;
            border-bottom: 1px solid #e5e5e5;
            gap: 12px;
            font-size: 0.875rem;
            color: #86868b;
        }
        .file-list-header label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .breadcrumb {
            margin-bottom: 15px;
            color: #86868b;
        }
        .breadcrumb a {
            color: #0071e3;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
        }
        button:hover {
            background: #0077ed;
        }
        button:disabled {
            background: #86868b;
            cursor: not-allowed;
        }
        button.secondary {
            background: #e5e5e5;
            color: #1d1d1f;
        }
        button.secondary:hover {
            background: #d5d5d5;
        }
        button.danger {
            background: #ff3b30;
        }
        button.danger:hover {
            background: #ff4d42;
        }
        select {
            padding: 10px 15px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }
        .job {
            padding: 15px;
            border-bottom: 1px solid #e5e5e5;
        }
        .job:last-child {
            border-bottom: none;
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .job-path {
            font-weight: 500;
            word-break: break-all;
        }
        .job-status, .encoder-badge {
            display: inline-block;
            min-width: 80px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            box-sizing: border-box;
        }
        .job-status.pending { background: #f5f5f7; color: #86868b; }
        .job-status.running { background: #fff3cd; color: #856404; }
        .job-status.complete { background: #d4edda; color: #155724; }
        .job-status.failed { background: #f8d7da; color: #721c24; }
        .job-status.cancelled { background: #e2e3e5; color: #383d41; }
        .job-status.initializing { background: #e0e7ff; color: #3730a3; }
        .encoder-badge { margin-left: 8px; }
        .encoder-badge.hardware { background: #d4edda; color: #155724; }
        .encoder-badge.software { background: #f8d7da; color: #721c24; }
        .progress-bar {
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #0071e3;
            transition: width 0.3s ease;
        }
        .progress-fill.initializing {
            background: linear-gradient(90deg, #c7d2fe 0%, #818cf8 50%, #c7d2fe 100%);
            background-size: 200% 100%;
            animation: shimmer 2.5s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .job-details {
            display: flex;
            gap: 20px;
            font-size: 0.875rem;
            color: #86868b;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .estimate {
            background: #f5f5f7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .estimate-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .savings {
            color: #34c759;
            font-weight: 600;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        #debug {
            font-family: monospace;
            font-size: 0.75rem;
            background: #1d1d1f;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .settings-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e5e5;
        }
        .setting-row:last-child {
            border-bottom: none;
        }
        .setting-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .setting-name {
            font-weight: 500;
            color: #1d1d1f;
        }
        .setting-description {
            font-size: 0.875rem;
            color: #86868b;
        }
        .setting-control select {
            min-width: 200px;
        }
        .settings-status {
            margin-top: 10px;
            font-size: 0.875rem;
            color: #34c759;
            min-height: 20px;
        }
        .settings-status.error {
            color: #ff3b30;
        }

        .settings-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e5e5;
            font-size: 12px;
            color: #999;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>üî¨ Shrinkray Debug UI</h1>

    <div class="card">
        <h2>Stats</h2>
        <div class="stats" id="stats">
            <div class="stat">
                <div class="stat-value" id="stat-pending">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-running">0</div>
                <div class="stat-label">Running</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-complete">0</div>
                <div class="stat-label">Complete</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-failed">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-saved">0 MB</div>
                <div class="stat-label">Saved</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>File Browser</h2>
        <div class="breadcrumb" id="breadcrumb">Loading...</div>
        <div class="file-list-header" id="file-list-header" style="display: none;">
            <label>
                <input type="checkbox" id="select-all-checkbox" class="file-checkbox" onchange="toggleSelectAll(this)">
                Select all
            </label>
            <span id="selection-count"></span>
        </div>
        <ul class="file-list" id="file-list">
            <li>Loading...</li>
        </ul>
        <div class="controls">
            <select id="preset-select">
                <option value="compress">Compress (Standard)</option>
                <option value="compress-hard">Compress (Smaller)</option>
                <option value="1080p">1080p</option>
                <option value="720p">720p</option>
            </select>
            <button onclick="getEstimate()" id="estimate-btn" disabled>Estimate Selected</button>
            <button onclick="startJobs()" id="start-btn" disabled>Start Transcode</button>
        </div>
        <div id="estimate-result"></div>
    </div>

    <div class="card">
        <h2>Job Queue</h2>
        <div id="jobs-list">No jobs</div>
        <div class="controls">
            <button onclick="clearCompleted()" class="secondary">Clear Completed</button>
            <button onclick="refreshJobs()">Refresh</button>
        </div>
    </div>

    <div class="card">
        <h2>Settings</h2>
        <div class="settings-grid" id="settings">
            <div class="setting-row">
                <div class="setting-label">
                    <span class="setting-name">Original files</span>
                    <span class="setting-description">What happens to source files after transcoding</span>
                </div>
                <div class="setting-control">
                    <select id="setting-original-handling" onchange="updateSetting('original_handling', this.value)">
                        <option value="replace">Replace (delete original)</option>
                        <option value="keep">Keep (rename to .old)</option>
                    </select>
                </div>
            </div>
            <div class="setting-row">
                <div class="setting-label">
                    <span class="setting-name">Concurrent jobs</span>
                    <span class="setting-description">Number of files to transcode simultaneously</span>
                </div>
                <div class="setting-control">
                    <select id="setting-workers" onchange="updateSetting('workers', parseInt(this.value))">
                        <option value="1">1 (recommended)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="settings-status" class="settings-status"></div>
        <div class="settings-footer">Shrinkray v<span id="app-version"></span></div>
    </div>

    <div class="card">
        <h2>Debug Log</h2>
        <div id="debug"></div>
    </div>

    <script>
        let currentPath = '';
        let selectedPaths = new Set();
        let eventSource = null;

        function log(msg) {
            const debug = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            debug.textContent = `[${time}] ${msg}\n` + debug.textContent;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            if (bytes < 0) return '0 B'; // Don't show negative savings
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        async function browse(path = '') {
            try {
                const url = path ? `/api/browse?path=${encodeURIComponent(path)}` : '/api/browse';
                const resp = await fetch(url);
                const data = await resp.json();

                currentPath = data.path;
                selectedPaths.clear();
                updateButtons();

                // Update breadcrumb
                const breadcrumb = document.getElementById('breadcrumb');
                let crumbs = `<a href="#" onclick="browse('')">Home</a>`;
                if (data.parent) {
                    crumbs += ` / <a href="#" onclick="browse('${data.parent}')">‚Üë Up</a>`;
                }
                crumbs += ` / ${data.path.split('/').pop() || 'Root'}`;
                breadcrumb.innerHTML = crumbs;

                // Update file list
                const list = document.getElementById('file-list');
                if (data.entries.length === 0) {
                    list.innerHTML = '<li class="file-item">Empty directory</li>';
                    return;
                }

                // Check if there are any selectable items (videos or folders)
                const hasSelectableItems = data.entries.some(e => (!e.is_dir && e.video_info) || e.is_dir);
                const header = document.getElementById('file-list-header');
                const selectAllCheckbox = document.getElementById('select-all-checkbox');
                header.style.display = hasSelectableItems ? 'flex' : 'none';
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;

                list.innerHTML = data.entries.map(entry => {
                    const count = entry.file_count || 0;
                    const meta = entry.is_dir
                        ? (count > 0 ? `${count} videos, ${formatBytes(entry.total_size || 0)}` : '')
                        : entry.video_info
                            ? `${entry.video_info.video_codec} ${entry.video_info.width}x${entry.video_info.height}, ${formatBytes(entry.size)}`
                            : formatBytes(entry.size);

                    const cls = entry.is_dir ? 'dir' : (entry.video_info ? 'video' : '');
                    const isVideo = !entry.is_dir && entry.video_info;
                    const isSelectable = isVideo || entry.is_dir;
                    const icon = entry.is_dir ? 'üìÅ' : (entry.video_info ? 'üé¨' : 'üìÑ');

                    return `<li class="file-item ${cls}"
                        data-path="${entry.path}"
                        data-is-dir="${entry.is_dir}"
                        onclick="handleFileClick(this, event)">
                        ${isSelectable ? `<input type="checkbox" class="file-checkbox" onclick="handleCheckbox(this, event)" data-path="${entry.path}">` : ''}
                        <span class="file-icon">${icon}</span>
                        <span class="file-name">${entry.name}</span>
                        <span class="file-meta">${meta}</span>
                    </li>`;
                }).join('');

                log(`Browsed: ${data.path} (${data.entries.length} items)`);
            } catch (err) {
                log(`Error browsing: ${err.message}`);
            }
        }

        function handleCheckbox(checkbox, event) {
            event.stopPropagation(); // Don't trigger the row click
            const path = checkbox.dataset.path;
            const row = checkbox.closest('.file-item');

            if (checkbox.checked) {
                selectedPaths.add(path);
                row.classList.add('selected');
            } else {
                selectedPaths.delete(path);
                row.classList.remove('selected');
            }
            updateButtons();
        }

        function handleFileClick(el, event) {
            const path = el.dataset.path;
            const isDir = el.dataset.isDir === 'true';

            // If clicking on a checkbox, let handleCheckbox deal with it
            if (event.target.classList.contains('file-checkbox')) {
                return;
            }

            if (isDir) {
                // Navigate into directory
                browse(path);
            } else {
                // Toggle selection for video files
                const checkbox = el.querySelector('.file-checkbox');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    if (checkbox.checked) {
                        selectedPaths.add(path);
                        el.classList.add('selected');
                    } else {
                        selectedPaths.delete(path);
                        el.classList.remove('selected');
                    }
                    updateButtons();
                }
            }
        }

        function updateButtons() {
            const hasSelection = selectedPaths.size > 0;
            document.getElementById('estimate-btn').disabled = !hasSelection;
            document.getElementById('start-btn').disabled = !hasSelection;

            // Update selection count
            const countEl = document.getElementById('selection-count');
            if (hasSelection) {
                countEl.textContent = `(${selectedPaths.size} selected)`;
            } else {
                countEl.textContent = '';
            }

            // Update select-all checkbox state
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const allCheckboxes = document.querySelectorAll('.file-item .file-checkbox');
            if (allCheckboxes.length > 0) {
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
            }
        }

        function toggleSelectAll(checkbox) {
            const allCheckboxes = document.querySelectorAll('.file-item .file-checkbox');
            allCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const row = cb.closest('.file-item');
                const path = cb.dataset.path;
                if (checkbox.checked) {
                    selectedPaths.add(path);
                    row.classList.add('selected');
                } else {
                    selectedPaths.delete(path);
                    row.classList.remove('selected');
                }
            });
            updateButtons();
        }

        async function getEstimate() {
            if (selectedPaths.size === 0) return;

            try {
                const preset = document.getElementById('preset-select').value;
                const resp = await fetch('/api/estimate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paths: Array.from(selectedPaths),
                        preset_id: preset
                    })
                });
                const data = await resp.json();

                if (data.error) {
                    document.getElementById('estimate-result').innerHTML =
                        `<div class="warning">${data.error}</div>`;
                    return;
                }

                const html = `
                    <div class="estimate">
                        <h3>Estimate: ${data.files.length} file(s) - ${data.preset_name}</h3>
                        <div class="estimate-row">
                            <span>Current size:</span>
                            <span>${formatBytes(data.total.current_size)}</span>
                        </div>
                        <div class="estimate-row">
                            <span>Estimated size:</span>
                            <span>${formatBytes(data.total.estimated_size)} (${formatBytes(data.total.estimated_size_min)} - ${formatBytes(data.total.estimated_size_max)})</span>
                        </div>
                        <div class="estimate-row">
                            <span>Space saved:</span>
                            <span class="savings">${formatBytes(data.total.space_saved)} (${data.total.savings_percent.toFixed(1)}%)</span>
                        </div>
                        <div class="estimate-row">
                            <span>Estimated time:</span>
                            <span>${formatDuration(data.total.estimated_time / 1000000000)}</span>
                        </div>
                        ${data.total.warning ? `<div class="warning">${data.total.warning}</div>` : ''}
                    </div>
                `;
                document.getElementById('estimate-result').innerHTML = html;
                log(`Estimate: ${formatBytes(data.total.current_size)} ‚Üí ${formatBytes(data.total.estimated_size)} (${data.total.savings_percent.toFixed(1)}% savings)`);
            } catch (err) {
                log(`Error estimating: ${err.message}`);
            }
        }

        async function startJobs() {
            if (selectedPaths.size === 0) return;

            try {
                const preset = document.getElementById('preset-select').value;
                const resp = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paths: Array.from(selectedPaths),
                        preset_id: preset
                    })
                });
                const data = await resp.json();

                if (data.error) {
                    log(`Error creating jobs: ${data.error}`);
                    return;
                }

                log(`Created ${data.count} job(s)`);
                selectedPaths.clear();
                document.querySelectorAll('.file-item.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                updateButtons();
                document.getElementById('estimate-result').innerHTML = '';
            } catch (err) {
                log(`Error creating jobs: ${err.message}`);
            }
        }

        async function cancelJob(id) {
            try {
                await fetch(`/api/jobs/${id}`, { method: 'DELETE' });
                log(`Cancelled job ${id}`);
            } catch (err) {
                log(`Error cancelling: ${err.message}`);
            }
        }

        async function clearCompleted() {
            try {
                const resp = await fetch('/api/jobs/clear', { method: 'POST' });
                const data = await resp.json();
                log(`Cleared ${data.cleared} completed jobs`);
                refreshJobs(); // Auto-refresh after clearing
            } catch (err) {
                log(`Error clearing: ${err.message}`);
            }
        }

        async function refreshJobs() {
            try {
                const resp = await fetch('/api/jobs');
                const data = await resp.json();
                updateJobs(data.jobs);
                updateStats(data.stats);
            } catch (err) {
                log(`Error refreshing: ${err.message}`);
            }
        }

        function updateJobs(jobs) {
            const container = document.getElementById('jobs-list');

            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<p style="color: #86868b; padding: 15px;">No jobs in queue</p>';
                return;
            }

            container.innerHTML = jobs.map(job => {
                const filename = job.input_path.split('/').pop();
                const encoderClass = job.is_hardware ? 'hardware' : 'software';
                const encoderLabel = job.is_hardware ? 'Hardware' : 'Software';
                const isInitializing = job.status === 'running' && job.progress === 0 && job.speed === 0;
                return `
                    <div class="job">
                        <div class="job-header">
                            <span class="job-path" title="${job.input_path}">${filename}</span>
                            <span>
                                <span class="encoder-badge ${encoderClass}">${encoderLabel}</span>
                                <span class="job-status ${job.status}">${isInitializing ? 'initializing' : job.status}</span>
                            </span>
                        </div>
                        ${job.status === 'running' ? `
                            <div class="progress-bar">
                                <div class="progress-fill ${isInitializing ? 'initializing' : ''}" style="width: ${isInitializing ? '100' : job.progress}%"></div>
                            </div>
                        ` : ''}
                        <div class="job-details">
                            <span>Preset: ${job.preset_id}</span>
                            ${job.status === 'running' ? (isInitializing ? `
                                <span>Starting encoder...</span>
                            ` : `
                                <span>${job.progress.toFixed(1)}%</span>
                                <span>Speed: ${job.speed.toFixed(2)}x</span>
                                <span>ETA: ${job.eta || 'calculating...'}</span>
                            `) : ''}
                            ${job.status === 'complete' ? `
                                <span>Saved: ${formatBytes(job.space_saved)}</span>
                                <span>${formatBytes(job.input_size)} ‚Üí ${formatBytes(job.output_size)}</span>
                            ` : ''}
                            ${job.status === 'failed' ? `<span style="color: #ff3b30">${job.error}</span>` : ''}
                        </div>
                        ${job.status === 'pending' || job.status === 'running' ? `
                            <button onclick="cancelJob('${job.id}')" class="danger" style="margin-top: 10px; padding: 5px 10px; font-size: 0.875rem;">Cancel</button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateStats(stats) {
            document.getElementById('stat-pending').textContent = stats.pending;
            document.getElementById('stat-running').textContent = stats.running;
            document.getElementById('stat-complete').textContent = stats.complete;
            document.getElementById('stat-failed').textContent = stats.failed;
            // Clamp to 0 - don't show negative savings
            const saved = Math.max(0, stats.total_saved || 0);
            document.getElementById('stat-saved').textContent = formatBytes(saved);
        }

        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/api/jobs/stream');

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'init') {
                    updateJobs(data.jobs);
                    updateStats(data.stats);
                    log('Connected to SSE stream');
                } else {
                    log(`Event: ${data.type} - ${data.job?.id || ''}`);
                    refreshJobs();

                    // Refresh file browser when a job completes to show updated metadata
                    if (data.type === 'complete' || data.type === 'failed') {
                        browse(currentPath);
                    }
                }
            };

            eventSource.onerror = () => {
                log('SSE connection lost, reconnecting...');
                setTimeout(connectSSE, 2000);
            };
        }

        // Settings functions
        async function loadSettings() {
            try {
                const resp = await fetch('/api/config');
                const config = await resp.json();

                // Display version
                if (config.version) {
                    document.getElementById('app-version').textContent = config.version;
                }

                // Set original handling dropdown
                const handlingSelect = document.getElementById('setting-original-handling');
                handlingSelect.value = config.original_handling || 'replace';

                // Set workers dropdown
                const workersSelect = document.getElementById('setting-workers');
                workersSelect.value = config.workers || 1;

                log(`Settings loaded: version=${config.version}, original_handling=${config.original_handling}, workers=${config.workers}`);
            } catch (err) {
                log(`Error loading settings: ${err.message}`);
            }
        }

        async function updateSetting(key, value) {
            const statusEl = document.getElementById('settings-status');
            try {
                const body = {};
                body[key] = value;

                const resp = await fetch('/api/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!resp.ok) {
                    const data = await resp.json();
                    throw new Error(data.error || 'Failed to update');
                }

                statusEl.textContent = 'Settings saved';
                statusEl.className = 'settings-status';
                log(`Setting updated: ${key}=${value}`);

                // Clear status after 2 seconds
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 2000);
            } catch (err) {
                statusEl.textContent = `Error: ${err.message}`;
                statusEl.className = 'settings-status error';
                log(`Error updating setting: ${err.message}`);
            }
        }

        // Initialize
        browse();
        connectSSE();
        loadSettings();

        // Load presets
        async function loadPresets() {
            const presets = await fetch('/api/presets').then(r => r.json());
            const select = document.getElementById('preset-select');
            select.innerHTML = presets.map(p =>
                `<option value="${p.id}">${p.name} - ${p.description}</option>`
            ).join('');
            log(`Loaded ${presets.length} presets`);
        }
        loadPresets();
    </script>
</body>
</html>
